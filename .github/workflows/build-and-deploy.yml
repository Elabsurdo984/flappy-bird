name: Build and Deploy Flappy Bird

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [web, windows, linux, macos]
        include:
          - platform: web
            export_preset: Web
            artifact_name: flappy-bird-web
            butler_channel: html5
          - platform: windows
            export_preset: Windows Desktop
            artifact_name: flappy-bird-windows
            butler_channel: windows
          - platform: linux
            export_preset: Linux
            artifact_name: flappy-bird-linux
            butler_channel: linux
          - platform: macos
            export_preset: macOS
            artifact_name: flappy-bird-macos
            butler_channel: mac

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Godot
      uses: chickensoft-games/setup-godot@v2
      with:
        version: 4.5.0
        use-dotnet: false
        include-templates: true

    - name: Verify Godot installation
      run: |
        godot --version
        ls -la ~/.local/share/godot/export_templates/ || echo "Templates directory not found"

    - name: Verify project structure
      run: |
        echo "Current directory:"
        pwd
        echo "Files in current directory:"
        ls -la
        echo "Checking for project.godot:"
        if [ -f "project.godot" ]; then
          echo "✅ project.godot found"
        else
          echo "❌ project.godot NOT found"
          exit 1
        fi

    - name: Import project resources
      run: |
        mkdir -p .godot/imported
        timeout 60 godot --headless --editor --quit-after 1 || true
        echo "Project import completed"

    - name: Export game for ${{ matrix.platform }}
      run: |
        mkdir -p builds/${{ matrix.platform }}
        if [ "${{ matrix.platform }}" == "web" ]; then
          godot --headless --export-release "${{ matrix.export_preset }}" builds/${{ matrix.platform }}/index.html
        elif [ "${{ matrix.platform }}" == "windows" ]; then
          godot --headless --export-release "${{ matrix.export_preset }}" builds/${{ matrix.platform }}/flappy-bird.exe
        elif [ "${{ matrix.platform }}" == "linux" ]; then
          godot --headless --export-release "${{ matrix.export_preset }}" builds/${{ matrix.platform }}/flappy-bird.x86_64
        elif [ "${{ matrix.platform }}" == "macos" ]; then
          godot --headless --export-release "${{ matrix.export_preset }}" builds/${{ matrix.platform }}/flappy-bird.zip
        fi
        echo "Export completed for ${{ matrix.platform }}"

    - name: List exported files
      run: |
        echo "Contents of builds/${{ matrix.platform }}:"
        ls -la builds/${{ matrix.platform }}/

    - name: Prepare artifact for ${{ matrix.platform }}
      run: |
        cd builds/${{ matrix.platform }}
        zip -r ../../${{ matrix.artifact_name }}.zip ./*
        cd ../..
        echo "Artifact created: ${{ matrix.artifact_name }}.zip"
        ls -lh ${{ matrix.artifact_name }}.zip

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.artifact_name }}.zip
        retention-days: 7

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure of downloaded files
      run: |
        echo "Artifacts structure:"
        ls -R artifacts/

    - name: Prepare release files
      run: |
        mkdir -p release_files
        find artifacts -name "*.zip" -exec cp {} release_files/ \;
        ls -lh release_files/

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: release_files/*.zip
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-itch:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && vars.ENABLE_ITCH_DEPLOY == 'true'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display artifacts
      run: |
        echo "Downloaded artifacts:"
        ls -R artifacts/

    - name: Setup Butler
      run: |
        curl -L -o butler.zip https://broth.itch.ovh/butler/linux-amd64/LATEST/archive/default
        unzip butler.zip
        chmod +x butler
        sudo mv butler /usr/local/bin/
        butler -V

    - name: Login to itch.io
      run: butler login
      env:
        BUTLER_API_KEY: ${{ secrets.ITCH_API_KEY }}

    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: Push Web build to itch.io
      run: |
        cd artifacts/flappy-bird-web
        unzip flappy-bird-web.zip -d web_build
        butler push web_build ${{ secrets.ITCH_USER }}/${{ secrets.ITCH_GAME }}:html5 --userversion ${{ steps.version.outputs.VERSION }}
      continue-on-error: true

    - name: Push Windows build to itch.io
      run: |
        cd artifacts/flappy-bird-windows
        unzip flappy-bird-windows.zip -d windows_build
        butler push windows_build ${{ secrets.ITCH_USER }}/${{ secrets.ITCH_GAME }}:windows --userversion ${{ steps.version.outputs.VERSION }}
      continue-on-error: true

    - name: Push Linux build to itch.io
      run: |
        cd artifacts/flappy-bird-linux
        unzip flappy-bird-linux.zip -d linux_build
        butler push linux_build ${{ secrets.ITCH_USER }}/${{ secrets.ITCH_GAME }}:linux --userversion ${{ steps.version.outputs.VERSION }}
      continue-on-error: true

    - name: Push macOS build to itch.io
      run: |
        cd artifacts/flappy-bird-macos
        unzip flappy-bird-macos.zip -d macos_build
        butler push macos_build ${{ secrets.ITCH_USER }}/${{ secrets.ITCH_GAME }}:mac --userversion ${{ steps.version.outputs.VERSION }}
      continue-on-error: true